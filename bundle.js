(()=>{"use strict";(()=>{const e=document.querySelector("body");window.main={isEscapeEvent(e,t){"Escape"===e.key&&(e.preventDefault(),t())},isEnterEvent(e,t){"Enter"===e.key&&t()},isRightEvent(e,t){"ArrowRight"===e.key&&t()},isLeftEvent(e,t){"ArrowLeft"===e.key&&t()},fixBody(){e.classList.add("modal-open")},unfixBody(){e.classList.remove("modal-open")}}})(),(()=>{const e=document.querySelector(".img-upload__form"),t=e.querySelector(".effect-level__value"),n=e.querySelector(".effect-level__depth"),o=e.querySelector(".effect-level__pin"),i=function(e){e>100?e=100:e<0&&(e=0),n.style.width=e+"%",o.style.left=e+"%",t.value=e};window.move={onMouseDown(e,i){e.preventDefault();let c=e.clientX;const r=function(e){e.preventDefault();const r=c-e.clientX;c=e.clientX;let s=o.offsetLeft-r;s>=453?s=453:s<0&&(s=0),n.style.width=s+"px",o.style.left=s+"px",t.value=Math.round(100*s/453),i()},s=function(e){e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",s)},onArrowRight(e,n){"ArrowRight"===e.key&&(i(Number(t.value)+10),n())},onArrowLeft(e,n){"ArrowLeft"===e.key&&(i(Number(t.value)-10),n())}},window.move.imageUploadForm=e,window.move.effectLevelPin=o,window.move.effectLevelDepth=n,window.move.effectLevelValue=t})(),(()=>{const e=document.querySelector(".img-upload"),t=e.querySelector(".img-upload__overlay"),n=e.querySelector("#upload-file"),o=e.querySelector("#upload-cancel"),i=function(e){"Escape"===e.key&&document.activeElement!==S&&document.activeElement!==E&&(e.preventDefault(),c())},c=function(){t.classList.add("hidden"),document.removeEventListener("keydown",i),window.main.unfixBody(),n.value="",S.value="",E.value=""};n.addEventListener("change",(function(){t.classList.remove("hidden"),document.addEventListener("keydown",i),window.main.fixBody(),u=1,m(),f(),w(),g(),_(),e.querySelector("[name=effect]").checked="none",d.classList.add("effects__preview--none"),y.classList.add("hidden")})),o.addEventListener("click",c),o.addEventListener("keydown",(function(e){window.main.isEnterEvent(e,c)}));const r=e.querySelector(".scale__control--smaller"),s=e.querySelector(".scale__control--bigger"),l=e.querySelector(".scale__control--value"),d=e.querySelector(".img-upload__preview img");let a=.25,u=1;const m=function(){l.value=100*u+"%"},f=function(){d.style.transform=`scale(${u})`},w=function(){u<=.25?(r.disabled=!0,r.classList.add("scale__control--disabled")):(r.disabled=!1,r.classList.remove("scale__control--disabled")),u>=1?(s.disabled=!0,s.classList.add("scale__control--disabled")):(s.disabled=!1,s.classList.remove("scale__control--disabled"))},v=function(){u-a>=.25&&(u-=a,m(),f(),w())},p=function(){u+a<=1&&(u+=a,m(),f(),w())};r.addEventListener("click",v),l.addEventListener("keydown",(function(e){window.main.isLeftEvent(e,v)})),s.addEventListener("click",p),l.addEventListener("keydown",(function(e){window.main.isRightEvent(e,p)}));const y=window.move.imageUploadForm.querySelector(".img-upload__effect-level");let L=100;const g=function(){L=100,window.move.effectLevelValue.value=L,window.move.effectLevelDepth.style.width=L+"%",window.move.effectLevelPin.style.left=L+"%"},_=function(){const e=window.move.imageUploadForm.querySelectorAll('input[type="radio"]');e.forEach(((t,n)=>{d.classList.remove("effects__preview--"+e[n].value)})),d.style.filter=""},h=function(){L=window.move.effectLevelValue.value,d.classList.contains("effects__preview--chrome")?d.style.filter=`grayscale(${.01*L})`:d.classList.contains("effects__preview--sepia")?d.style.filter=`sepia(${.01*L})`:d.classList.contains("effects__preview--marvin")?d.style.filter=`invert(${L}%)`:d.classList.contains("effects__preview--phobos")?d.style.filter=`blur(${.03*L}px)`:d.classList.contains("effects__preview--heat")&&(d.style.filter=`brightness(${3*(.3333+L/133.33)})`)};window.move.imageUploadForm.addEventListener("change",(function(e){e.target.matches('input[type="radio"]')&&(g(),_(),d.classList.add("effects__preview--"+e.target.value),"none"===e.target.value?y.classList.add("hidden"):y.classList.remove("hidden"))})),window.move.effectLevelPin.addEventListener("mousedown",(function(e){window.move.onMouseDown(e,h)})),window.move.effectLevelPin.addEventListener("keydown",(function(e){window.move.onArrowLeft(e,h)})),window.move.effectLevelPin.addEventListener("keydown",(function(e){window.move.onArrowRight(e,h)}));const E=window.move.imageUploadForm.querySelector(".text__hashtags"),S=window.move.imageUploadForm.querySelector(".text__description"),q=window.move.imageUploadForm.querySelector("#upload-submit"),k=function(){const e=E.value.toLowerCase().split(" "),t=/^#[a-zA-Zа-яА-ЯёЁ0-9]{1,19}$/;e.length>5?E.setCustomValidity("Используйте не более 5 хэш-тегов"):new Set(e).size<e.length?E.setCustomValidity("Хэш-теги не должны повторяться"):e.forEach((e=>{t.test(e)||""===E.value?E.setCustomValidity(""):E.setCustomValidity("Введите корректный хэш-тег")})),E.reportValidity()},b=function(){const e=S.value.length;e>140?S.setCustomValidity(`Сообщение слишком длинное. Удалите лишние ${e-140} симв.`):S.setCustomValidity(""),S.reportValidity()},C=function(){k(),b()};E.addEventListener("input",k),S.addEventListener("input",b),q.addEventListener("click",C),q.addEventListener("keydown",(function(e){window.main.isEnterEvent(e,C)}));const x=function(e,t,n){const o=e.cloneNode(!0),i=o.querySelector("button");o.querySelector("h2").textContent=t,i.textContent=n;const c=function(){o.remove()};i.addEventListener("click",c),document.addEventListener("click",c),document.addEventListener("keydown",(function(e){window.main.isEscapeEvent(e,c)})),document.querySelector("main").appendChild(o)},F=function(){c(),x(document.querySelector("#success").content.querySelector(".success"),"Изображение успешно загружено","Круто!")},D=function(e){c(),x(document.querySelector("#error").content.querySelector(".error").cloneNode(!0),e,"Попробовать загрузить другой файл")};window.move.imageUploadForm.addEventListener("submit",(function(e){e.preventDefault(),window.backend.upload(new FormData(window.move.imageUploadForm),F,D)})),window.renderResponse=x})(),(()=>{const e=["jpg","jpeg","png"],t=document.querySelector("#upload-file"),n=document.querySelector(".img-upload__preview img"),o=document.querySelectorAll(".effects__preview");t.addEventListener("change",(function(){const i=t.files[0],c=i.name.toLowerCase();if(e.some((function(e){return c.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(function(){n.src=e.result;for(let t=0;t<o.length;t++)o[t].style.backgroundImage=`url(${e.result})`})),e.readAsDataURL(i)}}))})(),window.debounce=function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}},(()=>{const e=function(e,t,n,o,i){const c=new XMLHttpRequest;c.responseType="json",c.addEventListener("load",(function(){200===c.status?e(c.response):t(`Статус ответа: ${c.status} ${c.statusText}`)})),c.addEventListener("error",(function(){t("Произошла ошибка соединения")})),c.addEventListener("timeout",(function(){t(`Запрос не успел выполниться за ${c.timeout} мс`)})),c.timeout=1e4,c.open(n,o),c.send(i)};window.backend={load(t,n){e(t,n,"GET","https://21.javascript.pages.academy/kekstagram/data")},upload(t,n,o){e(n,o,"POST","https://21.javascript.pages.academy/kekstagram",t)}}})(),(()=>{const e=document.querySelector("#picture").content.querySelector(".picture");window.renderPicture=function(t){const n=e.cloneNode(!0);return n.querySelector(".picture__img").src=t.url,n.querySelector(".picture__img").alt=t.description,n.querySelector(".picture__likes").textContent=t.likes,n.querySelector(".picture__comments").textContent=t.comments.length,n}})(),(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".social__comments"),n=e.querySelector(".comments-loader"),o=function(e){const t=document.createElement("li");t.classList.add("social__comment");const n=document.createElement("img");n.classList.add("social__picture"),n.src=e.avatar,n.alt=e.name,n.width="35",n.height="35",t.appendChild(n);const o=document.createElement("p");return o.classList.add("social__text"),o.textContent=e.message,t.appendChild(o),t},i=function(i,c){let r,s;i.length<=5?(r=i.length,n.classList.add("hidden")):(r=5,n.classList.remove("hidden"));const l=document.createDocumentFragment();for(let e=0;e<r;e++)l.appendChild(o(i[0])),i.shift();t.appendChild(l),s=c-i.length;let d=c%10==1&&11!==c?"комментария":"комментариев";e.querySelector(".social__comment-count").textContent=`${s} из ${c} ${d}`};window.renderBigPicture=function(o){e.querySelector(".big-picture__img img").src=o.url,e.querySelector(".likes-count").textContent=o.likes,e.querySelector(".social__caption").textContent=o.description,t.textContent="";const c=o.comments.length,r=o.comments.slice();i(r,c),n.addEventListener("click",(function(){i(r,c)}))},window.bigPicture=e})(),(()=>{const e=document.querySelector(".img-filters"),t=e.querySelector("#filter-random"),n=e.querySelector("#filter-discussed");window.filters={onChangeFilters:e=>(t.classList.contains("img-filters__button--active")?(e=function(e){let t,n;for(let o=e.length-1;o>0;o--)t=Math.floor(Math.random()*(o+1)),n=e[o],e[o]=e[t],e[t]=n;return e}(e)).length=e.length<10?e.length:10:n.classList.contains("img-filters__button--active")&&e.sort((function(e,t){return t.comments.length-e.comments.length})),e)},window.filters.imageFilters=e})(),(()=>{const e=document.querySelector(".pictures"),t=window.bigPicture.querySelector("#picture-cancel"),n=function(e){"Escape"===e.key&&(e.preventDefault(),o())},o=function(){window.bigPicture.classList.add("hidden"),document.removeEventListener("keydown",n),window.main.unfixBody(),window.bigPicture.querySelector(".social__footer-text").value=""},i=function(e){window.renderBigPicture(e),window.bigPicture.classList.remove("hidden"),document.addEventListener("keydown",n),window.main.fixBody()};let c=[];const r=function(t){const n=document.createDocumentFragment();for(let e=0;e<t.length;e++){const o=window.renderPicture(t[e]);o.addEventListener("click",(function(){i(t[e])})),o.addEventListener("keydown",(function(n){window.main.isEnterEvent(n,(function(){i(t[e])}))})),n.appendChild(o)}e.appendChild(n)},s=window.filters.imageFilters.querySelectorAll(".img-filters__button"),l=function(){window.filters.imageFilters.classList.remove("img-filters--inactive"),s.forEach((e=>{e.addEventListener("click",(function(){s.forEach((e=>{e.classList.remove("img-filters__button--active")})),e.classList.add("img-filters__button--active"),window.debounce((function(){!function(){document.querySelectorAll(".picture").forEach((e=>{e.remove()}));const e=c.slice();r(window.filters.onChangeFilters(e))}()}))()}))}))};window.backend.load((function(e){c=e,r(c),l()}),(function(e){window.renderResponse(document.querySelector("#error").content.querySelector(".error").cloneNode(!0),e,"ОК")})),t.addEventListener("click",o),t.addEventListener("keydown",(function(e){window.main.isEnterEvent(e,o)}))})()})();